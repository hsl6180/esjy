/*!
 * @cloudbase/weda-cloud-sdk
 * Copyright© 2022 Tencent
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx")):"function"==typeof define&&define.amd?define(["exports","mobx"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CloudSDK={},e.mobx)}(this,(function(e,t){"use strict";var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},n(e,t)};var r=function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},r.apply(this,arguments)};function a(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}c((r=r.apply(e,t||[])).next())}))}function o(e,t){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var i=function(e){function t(t,n){var r=e.call(this,n)||this;return r.code=t,r.name="TCBError",r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t}(Error);function s(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}var c,u={},f={};function l(e){if(!c)throw new Error("app config not inited");return e?c[e]:c}function d(e){var t=p(e);if(t){if("database"===t.type){if(t.schema&&t.schema["x-viewId"])return t.schema["x-viewId"];console.warn("[weda-cloud-sdk]datasource",e,"is not database or viewId is empty")}}else console.warn("[weda-cloud-sdk]can not find datasource with options",e)}function p(e){if(c&&c.dataSourceProfiles&&c.dataSourceProfiles.length){var t="string"==typeof e?{val:e,key:"name"}:e,n="function"==typeof t?t:function(e){return e&&e[t.key]===t.val};return c.dataSourceProfiles.find(n)}console.warn("[weda-cloud-sdk]datasource profile is empty")}function v(e){c=Object.assign(c||{},e)}function h(e){return c.useLegacyDatasource?"lcap-".concat(e.id,"-").concat(e.name).concat(c.isProd?"":"-preview"):"lowcode-datasource".concat(c.isProd?"":"-preview")}function m(e){return!e&&c.useLegacyDatasource?"lcap-common-service":"lowcode-datasource".concat(c.isProd?"":"-preview")}function w(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}var g=[];function y(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=g.find((function(n){return n[0]===e&&w(n[1],t)}));if(r)return r[2];var a=e.apply(void 0,t);return g.push([e,t,a]),a}function b(e,t){if(!e)return e;return t.reduce((function(t,n){return s(e,n)&&(t[n]=e[n]),t}),{})}var O={};function D(e,t){O[e]=t}function S(e,t){var n=O[e];return n&&"function"==typeof n?n(t):n}function T(e){return function(t){D(e,t)}}var I={tempURLMaxWaitGap:50};function _(e){Object.assign(I,e)}function N(){return"undefined"!=typeof window&&window||"undefined"!=typeof globalThis&&globalThis}function E(){try{var e=N();if(!e)return;return"undefined"==typeof wx?N().location.href:e.__wxRoute}catch(e){}}function U(){var e,t=N();return(null==t?void 0:t.navigator)?t.navigator.userAgent:"undefined"!=typeof wx&&wx.getSystemInfo?(wx.getSystemInfo({success:function(t){t&&(e=["brand","model","version","system","platform","SDKVersion","language"].map((function(e){return"".concat(e,": ").concat(t[e])})).join(", "))}}),e):void 0}!function(){try{if(_({userAgent:U()}),"undefined"!=typeof window&&window&&window.top){var e=window.__wconfig||top.location.search,t={};if(/\b__wedaTarget=([^&]+)/.test(e)){var n=decodeURIComponent(RegExp.$1);n&&(t.wedaTarget=n)}/\b__useLegacy=true\b/.test(e)&&(t.useLegacyDatasource=!0),v(t)}}catch(e){}}();var C="1.0.7";function A(e){return a(this,void 0,void 0,(function(){var t,n,r,a,i,s,c;return o(this,(function(o){switch(o.label){case 0:(t=Object.assign({},e)).dataSourceName=t.name||t.dataSourceName,delete t.name,o.label=1;case 1:if(o.trys.push([1,3,,4]),(n=l("beforeDSRequest"))&&n(t),!(r=u[t.dataSourceName]))throw new Error("datasource ".concat(t.dataSourceName," not found"));if(!(a=r[t.methodName]))throw new Error("method ".concat(t.methodName," not found in datasource ").concat(t.dataSourceName," "));return[4,a(t.params,t.extraParams)];case 2:return i=o.sent(),(c=l("afterDSRequest"))&&c(t,null,i),[2,i];case 3:throw s=o.sent(),(c=l("afterDSRequest"))&&c(t,s),s;case 4:return[2]}}))}))}var R={get dataSources(){return v({parseBusinessInfo:!0}),u},get callDataSource(){return v({parseBusinessInfo:!0}),A},get callConnector(){return v({parseBusinessInfo:!0}),A},get callModel(){return v({parseBusinessInfo:!0}),A}};function P(e,t){return a(this,void 0,void 0,(function(){var n,r,a,s,c,u,f,d,p;return o(this,(function(o){switch(o.label){case 0:return n=l("initTcb"),r=l("isProd"),a=l("afterCallFunction"),s={wedaAppId:l("appID"),userAgent:I.userAgent,referrer:E(),envType:r?"prod":"pre",wedaTarget:l("wedaTarget"),"x-cloud-sdk-version":C},e.data=Object.assign({},e.data,s),(c=null==t?void 0:t.app)?[3,2]:[4,n()];case 1:u=o.sent(),c=u.app,o.label=2;case 2:return o.trys.push([2,4,,5]),[4,c.callFunction(e)];case 3:return f=o.sent(),a&&a(e,null,JSON.parse(JSON.stringify(f))),[3,5];case 4:throw d=o.sent(),a&&a(e,d),d;case 5:if(null==t?void 0:t.unwrapResult){if(p=f.result,!t.parseBusinessInfo)return[2,p];if(!p.code)return[2,p.data];throw console.warn("[weda-cloud-sdk]failed to call cloud function: ",p),new i(p.code,p.message)}return[2,f]}}))}))}function F(e,t){if("OPERATION_FAIL"===e.code||/OPERATION_FAIL/.test(e.message)){if(/FUNCTION_NOT_FOUND/.test(e.message)){var n=(null==t?void 0:t.FUNCTION_NOT_FOUND)||"找不到数据源的云函数";throw new i("FUNCTION_NOT_FOUND",n)}if(/FUNCTIONS_EXECUTE_FAIL/.test(e.message)){n=(null==t?void 0:t.FUNCTIONS_EXECUTE_FAIL)||"云函数执行失败";throw new i("FUNCTIONS_EXECUTE_FAIL",n)}}if(/network request error/.test(e.message))throw new i("NETWORK_ERROR","网络故障, 请检查本地网络连接是否正常");if(/method .* not found in datasource/i.test(e.message)){n=(null==t?void 0:t.DS_METHOD_NOT_FOUND)||"找不到数据源的方法";throw new i("DS_METHOD_NOT_FOUND",n)}if(null==t?void 0:t.DEFAULT_ERROR)throw new i(e.code||"DEFAULT_ERROR",t.DEFAULT_ERROR);throw e}function L(e,t){return a(this,void 0,void 0,(function(){return o(this,(function(n){return[2,P({name:m(),data:r(r({},e),{mode:"c"})},{app:t,unwrapResult:!0,parseBusinessInfo:!0}).catch((function(e){F(e,{FUNCTION_NOT_FOUND:"微搭环境异常: 未找到数据源公共云函数",FUNCTIONS_EXECUTE_FAIL:"微搭环境异常: 数据源公共云函数调用失败"})}))]}))}))}function x(e){return a(this,void 0,void 0,(function(){return o(this,(function(t){return[2,L({methodName:"callWedaApi",params:e}).then((function(e){return e.Data}))]}))}))}var j={wrapperDatasourceMethod:function(e){return function(t){return R.callDataSource({name:e.dataSourceName,methodName:e.methodName,params:t})}}},k={},$=[],M=[],B=[];var q=0,V=0;function W(){return a(this,void 0,void 0,(function(){var e,t,n,r,a;return o(this,(function(o){switch(o.label){case 0:e=M.splice(0),$=$.concat(e),o.label=1;case 1:return o.trys.push([1,4,,5]),[4,l("initTcb")()];case 2:return[4,o.sent().app.getTempFileURL({fileList:e})];case 3:return t=o.sent(),$=$.filter((function(t){return!e.includes(t)})),t.code&&"SUCCESS"!==t.code||!Array.isArray(t.fileList)?(console.warn("[cloud.getTempFileURL]server response error",t),X({},e),[2]):(n={},r=[],t.fileList.forEach((function(e){var t;(s(t=e,"code")?"SUCCESS"===t.code:s(t,"status")&&!t.status)?n[e.fileID]=e.tempFileURL:(console.warn("[cloud.getTempFileURL]single item failed",e),r.push(e.fileID))})),X(n,r),[3,5]);case 4:return a=o.sent(),$=$.filter((function(t){return!e.includes(t)})),console.warn("[cloud.getTempFileURL] request failed",a),X({},e),[3,5];case 5:return[2]}}))}))}function X(e,t){Object.assign(k,e),B.forEach((function(e){var n=K(e.fileIds,t);!1!==n&&(e.resolve(n),e.isDone=!0)})),B=B.filter((function(e){return!e.isDone}))}function K(e,t){void 0===t&&(t=[]);try{if(Array.isArray(e)){return e.reduce((function(e,n){var r=k[n];if(!r){if(t.includes(n))return e;throw new Error("not found")}return e[n]=r,e}),{})}var n=k[e];if(!n){if(t.includes(e))return;throw new Error("not found")}return n}catch(e){return!1}}var G=Object.assign(R,{IS_WEDA_IDE:!1,version:C,utils:j,getCloudInstance:function(){return a(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,l("initTcb")()];case 1:return[2,e.sent().app]}}))}))},callGraphql:function(e){return a(this,void 0,void 0,(function(){var t,n,r,a;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),(t=l("beforeDSRequest"))&&t(e),[4,P({name:m(!0),data:{mode:"graphql",params:e}},{unwrapResult:!0})];case 1:return n=o.sent(),(a=l("afterDSRequest"))&&a(e,null,n),[2,n];case 2:throw r=o.sent(),(a=l("afterDSRequest"))&&a(e,r),r;case 3:return[2]}}))}))},callFunction:P,callWorkflow:function(e){return a(this,void 0,void 0,(function(){return o(this,(function(t){return[2,x(e)]}))}))},callWedaApi:x,callCommonService:L,getTempFileURL:function(e){var t=function(e){var t=e&&"object"==typeof e&&e.fileList?e.fileList:e;return"string"==typeof t||Array.isArray(t)?t:void 0}(e);if(!t||!t.length)return Promise.resolve();var n=K(t);return!1!==n?Promise.resolve(n):new Promise((function(e,n){!function(e,t,n){B.push({fileIds:e,resolve:t,reject:n});var r=Array.isArray(e)?e:[e];M.length&&(r=r.filter((function(e){return!M.includes(e)})));r.length&&$.length&&(r=r.filter((function(e){return!$.includes(e)})));r.length&&(r=r.filter((function(e){return!k[e]})));if(!r.length)return;M=M.concat(r),clearTimeout(V);var a=Date.now();q=!q||a>q?a+I.tempURLMaxWaitGap:q,V=setTimeout(W,q-a)}(t,e,n)}))},getDataSourceViewId:d,getDataSourceProfile:p,setConfig:_,checkAuth:function(e){return x({action:"DescribeWedaAccessResourcesByType",data:e})},setDataSourceDefaultParams:D});var H=["getItem","getList","delete","update","create","getRecords"];function J(e){var t,n=[];if("database"===e.type&&Array.isArray(null===(t=e.schema)||void 0===t?void 0:t["x-defaultMethods"])){var r=e.schema["x-defaultMethods"].map((function(e){return e.replace(/^weda([A-Z])/,(function(e,t){return t.toLowerCase()}))}));-1===r.indexOf("getRecords")&&r.push("getRecords");var i=r.map((function(e){return"weda".concat(e.charAt(0).toUpperCase()).concat(e.slice(1))}));n=r.filter((function(e){return H.includes(e)})).concat(i)}e.methods&&n.push.apply(n,e.methods.map((function(e){return e.name})));var s={$setDefaultParams:T(e.name)};return n.reduce((function(t,n){return t[n]=function(e,t){return function(n,r){return a(this,void 0,void 0,(function(){var a,i,s,c;return o(this,(function(o){switch(o.label){case 0:(a=l("parseBusinessInfo"))&&v({parseBusinessInfo:!1}),i=h(e),o.label=1;case 1:return o.trys.push([1,3,,4]),s={params:n,methodName:t},[4,P({name:i,data:Object.assign(r||{},{dataSourceName:e.name,viewId:d({key:"name",val:e.name}),methodName:t,defaultParams:S(e.name,s),params:n})},{unwrapResult:!0,parseBusinessInfo:a})];case 2:return[2,o.sent()];case 3:return c=o.sent(),console.warn("[weda-cloud-sdk] failed to invoke datasource ".concat(e.name,"'s method ").concat(t),c),a&&F(c,{FUNCTION_NOT_FOUND:"找不到数据源".concat(e.name,"(").concat(e.id,")的云函数"),DS_METHOD_NOT_FOUND:"数据源".concat(e.name,"(").concat(e.id,")中的方法").concat(t,"不存在或者未启用"),FUNCTIONS_EXECUTE_FAIL:"调用数据源".concat(e.name,"(").concat(e.id,")方法").concat(t,"失败: 请检查该数据源所有自定义方法的代码中是否存在语法错误"),DEFAULT_ERROR:"调用数据源".concat(e.name,"(").concat(e.id,")方法").concat(t,"失败: ").concat(c.errMsg||c.message)}),[2,{code:c.errCode||-2,message:"调用数据源".concat(e.name,"(").concat(e.id,")方法").concat(t,"失败: ").concat(c.errMsg||c.message)}];case 4:return[2]}}))}))}}(e,n),t}),s)}var Z={get $call(){return v({parseBusinessInfo:!1}),A}};function z(){Object.keys(u).forEach((function(e){Object.defineProperty(Z,e,{get:function(){return v({parseBusinessInfo:!1}),u[e]},configurable:!0,enumerable:!0})}))}function Q(e,t){var n=e.split(".");if(2===n.length){var r=n[0];if("$page"===r){var a=l("currentPageId");if(!a||"$global"===a)return void console.warn("[weda-cloud-sdk]setStateVar: can not find currentPageId",r);r=a}var o=f[r],i=n[1];if(o&&(s(o.state.$status,i)||s(o.state,i))){if(o.state.$status[i]){if(t instanceof Error)return void(o.state.$status[i]={status:"failed",code:t.code||-1,message:t.message,error:t});"success"!==o.state.$status[i].status&&(o.state.$status[i]={status:"success"})}o.state[i]=t}}else console.warn("[weda-cloud-sdk]setStateVar: invalid varPath",e)}z();var Y={setState:Q,setParams:function(e,t){var n=(l("datasetProfiles")||{})[e],r=f[e];r&&n&&n.params&&(r.params=b(t,Object.keys(n.params)))}};function ee(e,t){if(e){var n=Object.keys(e);if(!n.length)return{};return n.reduce((function(n,r){if(n[r]="",t){var a=e[r];n[r]=a.sampleValue||""}return n}),{})}}function te(e){if(!e)return{};return Object.keys(e).reduce((function(t,n){var r=e[n];return"state"!==r.varType||(t[n]=r.initialValue),t}),{})}function ne(e){var t=e.dataSourceProfiles;if(v(e),t){var n=l("customCreateDataSources");if(n)return n(t),void Object.assign(Z,u);t.reduce((function(e,t){return e[t.name]=J(t),e}),u),z()}}function re(){return a(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:return(e=l()).resourceAppid?[4,(t=wx.cloud.Cloud({resourceAppid:e.resourceAppid,resourceEnv:e.envID})).init()]:[3,2];case 1:return n.sent(),[3,3];case 2:(t=wx.cloud).init({env:e.envID}),n.label=3;case 3:return e.afterTcbLogin?[4,e.afterTcbLogin({userType:"anonymousUser"},t).catch((function(e){console.warn("[weda-cloud-sdk] failed to sign-in/getUserInfo weda backend",e)}))]:[3,5];case 4:n.sent(),n.label=5;case 5:return[2,{app:t}]}}))}))}function ae(){return a(this,void 0,void 0,(function(){return o(this,(function(e){return[2,y(re)]}))}))}var oe="lcap-user-session",ie=null;function se(e,t){return a(this,void 0,void 0,(function(){var n,r;return o(this,(function(a){switch(a.label){case 0:return ie?[2,ie]:[4,L({wx_phone:(null==e?void 0:e.phoneCloudID)?wx.cloud.CloudID(e.phoneCloudID):void 0,methodName:"signIn",params:e},t)];case 1:return n=a.sent(),delete(r=Object.assign({},n,e,{lastUpdateTime:Date.now()})).phoneCloudID,ie=r,wx.setStorageSync(oe,r),[2,r]}}))}))}v({afterTcbLogin:se});var ce={signIn:se,signOut:function(){return a(this,void 0,void 0,(function(){return o(this,(function(e){return console.warn("[weda-cloud-sdk]should not be called in miniapp"),[2]}))}))},getUserInfo:function(){return a(this,void 0,void 0,(function(){var e;return o(this,(function(t){return ie?[2,ie]:(e=wx.getStorageSync(oe))?!e.lastUpdateTime||Date.now()-e.lastUpdateTime>2592e5?[2,null]:(ie=e,[2,e]):[2,e]}))}))},get currentUser(){return ie?Object.assign({},ie):null}};Object.assign(G,ce),Object.defineProperty(G,"currentUser",{get:function(){return ce.currentUser}}),ne({initTcb:ae}),e.CLOUD_SDK=G,e.DATASET_CONTEXT=f,e.DS_API=u,e.DS_SDK=Z,e.EXTRA_API=Y,e.TCBError=i,e._setConfig=v,e.callDataSource=A,e.createDataset=function(e,n){v({currentPageId:e});var r=(l("datasetProfiles")||{})[e],a=t.observable({state:{$status:{}},params:{}});if(f[e]=a,!r)return a;var o=ee(r.params,n),i=te(r.state);return Object.assign(a.params,o),Object.assign(a.state,i),a},e.createParamsVar=ee,e.createSetDefaultParams=T,e.createStateDataSourceVar=function(e,t){var n,r;return a(this,void 0,void 0,(function(){var i,s,c,u=this;return o(this,(function(d){return i=null===(n=f[e])||void 0===n?void 0:n.state,s=l("datasetProfiles")||{},c=null===(r=s[e])||void 0===r?void 0:r.state,i&&c?(Object.keys(c).forEach((function(n){return a(u,void 0,void 0,(function(){var r,a,s,u;return o(this,(function(o){switch(o.label){case 0:if("datasource"!==(r=c[n]).varType)return[2];if(!r.initMethod||!r.initMethod.name)return i[n]={},i.$status[n]={status:"idle"},[2];o.label=1;case 1:return o.trys.push([1,3,,4]),i.$status[r.name]={status:"loading"},a=r.initMethod,[4,G.callDataSource({name:r.dataSourceName,methodName:a.name,params:t(a.params,a),options:{showLoading:!0}})];case 2:return s=o.sent(),Q("".concat(e,".").concat(r.name),s),[3,4];case 3:return u=o.sent(),console.error("[weda-cloud-sdk] failed to init ".concat(e,".").concat(r.name),u),Q("".concat(e,".").concat(r.name),u),[3,4];case 4:return[2]}}))}))})),[2]):[2]}))}))},e.createStaticStateVar=te,e.execOnce=y,e.generateParamsParser=function(e){return function(t){if(!t)return t;var n={};return Object.keys(t).forEach((function(r){n[r]=t[r](e.app,e.$page)})),n}},e.getCommonCloudFnName=m,e.getConfig=l,e.getDataSourceProfile=p,e.getDataSourceViewId=d,e.getDatasourceCloudFnName=h,e.getDefaultParams=S,e.hasOwn=s,e.initTcb=ae,e.isSameArray=w,e.pick=b,e.setConfig=ne,e.setDefaultParams=D,Object.defineProperty(e,"__esModule",{value:!0})}));
